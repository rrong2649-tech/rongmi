<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>èŒ¸èŒ¸ç±³ç±³ã®å¤§å†’é™© - æ²™é›•å¤§ä½œæˆ˜</title>
    
    <!-- iOS Web App é…ç½® (ä¿è¯å…¨å±å’Œæ²‰æµ¸å¼ä½“éªŒ) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">

    <!-- === è‡ªå®šä¹‰å›¾æ ‡å¼•ç”¨ (ä¼šä¼˜å…ˆæŸ¥æ‰¾ apple-touch-icon.png æ–‡ä»¶) === -->
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    <!-- å¼•å…¥ React å’Œ Tailwind (å›½å†…æé€Ÿ CDN) -->
    <script src="https://cdn.staticfile.org/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.staticfile.org/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.staticfile.org/babel-standalone/7.23.6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #FFF8E1;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .animate-bounce-custom { animation: bounce 2s infinite; }
        .animate-shake { animation: shake 0.5s infinite; }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }

        /* æ¸¸æˆç‰¹å®šçš„ CSS */
        .game-canvas {
            touch-action: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 0. å›¾æ ‡ç»„ä»¶ (å†…ç½® SVG) ---
        
        const IconBase = ({ children, size = 24, className = "", style = {}, fill = "none" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>
                {children}
            </svg>
        );

        const Star = (props) => (
            <IconBase {...props}>
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </IconBase>
        );

        const Lock = (props) => (
            <IconBase {...props}>
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </IconBase>
        );

        const Trophy = (props) => (
            <IconBase {...props}>
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                <path d="M4 22h16"></path>
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
            </IconBase>
        );

        const Play = (props) => (
            <IconBase {...props} fill={props.fill || "currentColor"}>
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </IconBase>
        );

        const Home = (props) => (
            <IconBase {...props}>
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </IconBase>
        );

        const RotateCcw = (props) => (
            <IconBase {...props}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
            </IconBase>
        );

        const Zap = (props) => (
            <IconBase {...props}>
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
            </IconBase>
        );

        const Brain = (props) => (
            <IconBase {...props}>
                <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"></path>
                <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"></path>
            </IconBase>
        );

        const Mic = (props) => (
            <IconBase {...props}>
                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" x2="12" y1="19" y2="22"></line>
            </IconBase>
        );

        // --- 1. è§’è‰²ç»„ä»¶ (SVG) ---

        const Mimi = ({ className, emotion = 'normal' }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <g transform="translate(10,10)">
                    <path d="M5 20 Q0 40 10 50 L15 30 Z" fill="#E63946" stroke="#333" strokeWidth="2"/>
                    <path d="M75 20 Q80 40 70 50 L65 30 Z" fill="#E63946" stroke="#333" strokeWidth="2"/>
                    <circle cx="40" cy="40" r="35" fill="#FFF5F0" stroke="#333" strokeWidth="2"/>
                    <path d="M20 15 Q40 -5 60 15 Q40 25 20 15 Z" fill="#1A1A1A"/>
                    <path d="M60 15 Q65 20 62 25" fill="none" stroke="#E63946" strokeWidth="4" strokeLinecap="round"/>
                    {emotion === 'shock' ? (
                        <>
                            <circle cx="30" cy="35" r="4" fill="#333"/>
                            <circle cx="50" cy="35" r="4" fill="#333"/>
                            <ellipse cx="40" cy="55" rx="8" ry="10" fill="#333"/>
                        </>
                    ) : (
                        <>
                            <path d="M25 35 Q30 30 35 35" fill="none" stroke="#333" strokeWidth="2" strokeLinecap="round"/>
                            <path d="M45 35 Q50 30 55 35" fill="none" stroke="#333" strokeWidth="2" strokeLinecap="round"/>
                            <path d="M35 50 Q40 55 45 50" fill="none" stroke="#333" strokeWidth="2" strokeLinecap="round"/>
                        </>
                    )}
                    <circle cx="20" cy="50" r="3" fill="#FFA5A5" opacity="0.6"/>
                    <circle cx="60" cy="50" r="3" fill="#FFA5A5" opacity="0.6"/>
                </g>
            </svg>
        );

        const Rongrong = ({ className, emotion = 'normal' }) => (
            <svg viewBox="0 0 100 100" className={className}>
                <g transform="translate(10,10)">
                    <circle cx="15" cy="15" r="10" fill="#8D6E63" stroke="#333" strokeWidth="2"/>
                    <circle cx="65" cy="15" r="10" fill="#8D6E63" stroke="#333" strokeWidth="2"/>
                    <circle cx="40" cy="40" r="35" fill="#D7CCC8" stroke="#333" strokeWidth="2"/>
                    <path d="M40 5 L45 15 L35 15 Z" fill="#4E342E"/>
                    <path d="M5 40 L15 45 L15 35 Z" fill="#4E342E"/>
                    <path d="M75 40 L65 45 L65 35 Z" fill="#4E342E"/>
                    {emotion === 'shock' ? (
                        <>
                            <line x1="25" y1="35" x2="35" y2="35" stroke="#333" strokeWidth="2"/>
                            <line x1="45" y1="35" x2="55" y2="35" stroke="#333" strokeWidth="2"/>
                            <circle cx="40" cy="55" r="5" fill="#333"/>
                        </>
                    ) : (
                        <>
                            <circle cx="30" cy="35" r="3" fill="#333"/>
                            <circle cx="50" cy="35" r="3" fill="#333"/>
                            <path d="M35 52 Q40 58 45 52" fill="none" stroke="#333" strokeWidth="2" strokeLinecap="round"/>
                        </>
                    )}
                </g>
            </svg>
        );

        // --- 2. æ¸¸æˆé…ç½®æ•°æ® ---

        const GAMES = [
            // å·²å°†â€œèº²å¼€å‰ä»»â€ä¿®æ”¹ä¸ºâ€œèº²å¼€æ€ªå…½â€
            { id: 'avoid_ex', name: 'èº²å¼€æ€ªå…½', desc: 'å·¦å³æ»‘åŠ¨èº²é¿æ€ªå…½ï¼Œæ”¶é›†å¥¶èŒ¶ï¼', icon: <Zap />, cost: 0, threshold: 0 },
            { id: 'wake_up', name: 'å”¤é†’èŒ¸èŒ¸', desc: 'ç–¯ç‹‚ç‚¹å‡»å±å¹•æŠŠç¡æ­»çš„èŒ¸èŒ¸å«é†’ï¼', icon: <Mic />, cost: 5, threshold: 30 }, 
            { id: 'sushi_duel', name: 'æŠ¢ä¸‰æ–‡é±¼', desc: 'çœ‹åˆ°ç»¿è‰²ä¿¡å·ç¬é—´ç‚¹å‡»ï¼æ‹¼æ‰‹é€Ÿï¼', icon: <Trophy />, cost: 10, threshold: 50 },
            { id: 'mind_reader', name: 'é»˜å¥‘è€ƒéªŒ', desc: 'å›ç­”å…³äºå½¼æ­¤çš„é€å‘½é¢˜ï¼', icon: <Brain />, cost: 15, threshold: 80 }
        ];

        const STORY_NODES = [
            { 
                id: 'intro', 
                shardsRequired: 0, 
                title: "ä¸€åˆ‡çš„å¼€å§‹",
                dialogs: [
                    { char: 'narrator', text: 'æŸå¤©ï¼Œå¤–æ˜Ÿäººå·èµ°äº†å…¨ä¸–ç•Œçš„â€œæ­£å¸¸èŠ‚æ“â€...' },
                    { char: 'mimi', text: 'ç­‰ç­‰ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬æ²¡äº‹ï¼Ÿ' },
                    { char: 'rong', text: 'å› ä¸ºæˆ‘ä»¬æœ¬æ¥å°±æ²¡æœ‰èŠ‚æ“å§ï¼Ÿ' },
                    { char: 'narrator', text: 'æ€»ä¹‹ï¼ä¸ºäº†æ‹¯æ•‘ä¸–ç•Œï¼ˆé¡ºä¾¿èµšå¤–å¿«ï¼‰ï¼Œæœ€æ²™é›•çš„ç»„åˆå‡ºå‡»äº†ï¼' }
                ] 
            },
            { 
                id: 'chapter1', 
                shardsRequired: 10, 
                title: "å°´å°¬èˆä¼š",
                dialogs: [
                    { char: 'rong', text: 'å‰é¢æ˜¯â€œå°´å°¬èˆä¼šæ˜Ÿçƒâ€ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€ç¤¾æçš„å‘³é“ã€‚' },
                    { char: 'mimi', text: 'çœ‹æˆ‘çš„ï¼åªè¦æˆ‘å¤Ÿä¸è¦è„¸ï¼Œå°´å°¬çš„å°±æ˜¯åˆ«äººï¼' },
                    { char: 'narrator', text: 'è§£é”æ–°åŒºåŸŸï¼šæ›´å¤šé«˜éš¾åº¦æ¸¸æˆå·²å¼€æ”¾ï¼' }
                ] 
            },
            {
                 id: 'chapter2',
                 shardsRequired: 30,
                 title: "åºŸè¯ç‹å›½",
                 dialogs: [
                     { char: 'mimi', text: 'è¿™é‡Œçš„å›½ç‹è¯´ï¼šâ€œå¬å›ä¸€å¸­è¯ï¼Œå¦‚å¬ä¸€å¸­è¯â€ã€‚' },
                     { char: 'rong', text: 'è¿™ä¸å°±æ˜¯ä½ çš„æ—¥å¸¸å—ï¼Ÿ' },
                     { char: 'narrator', text: 'æ”¶é›†æ›´å¤šèŠ‚æ“æ¥å‡»è´¥åºŸè¯ä¹‹ç‹ï¼' }
                 ]
            },
            {
                id: 'ending',
                shardsRequired: 60,
                title: "æ­£å¸¸äººä¹‹ç¥",
                dialogs: [
                    { char: 'mimi', text: 'ç»ˆäºè§åˆ°äº†æœ€ç»ˆBOSS...' },
                    { char: 'rong', text: 'åªè¦æˆ‘ä»¬ä¿æŒæ²™é›•ï¼Œå°±æ²¡æœ‰äººèƒ½æ‰“è´¥æˆ‘ä»¬ï¼' },
                    { char: 'narrator', text: 'æ­å–œé€šå…³ï¼ä½ ä»¬æ˜¯å®‡å®™æœ€å¼ºæ²™é›•ç»„åˆï¼' }
                ]
            }
        ];

        // --- 3. å°æ¸¸æˆç»„ä»¶å®ç° ---

        // 3.1 èº²å¼€æ€ªå…½ (Avoid Monster) - å·²ä¿®å¤ç”µè„‘æ“ä½œæ”¯æŒ
        const GameAvoidEx = ({ onFinish }) => {
            const [playerX, setPlayerX] = useState(50);
            const [score, setScore] = useState(0);
            const [gameOver, setGameOver] = useState(false);
            const [items, setItems] = useState([]); // {x, y, type: 'monster'|'tea'}
            const requestRef = useRef();
            
            // ç»Ÿä¸€è¾“å…¥å¤„ç†å‡½æ•°ï¼šå…¼å®¹é¼ æ ‡å’Œè§¦æ‘¸
            const handleInput = (clientX) => {
                const width = window.innerWidth;
                const x = (clientX / width) * 100;
                setPlayerX(Math.min(90, Math.max(10, x)));
            };

            const handleTouch = (e) => handleInput(e.touches[0].clientX);
            const handleMouse = (e) => handleInput(e.clientX);

            const loop = () => {
                if (gameOver) return;

                setItems(prev => {
                    let nextItems = prev.map(item => ({ ...item, y: item.y + 1.5 })); // ä¸‹è½é€Ÿåº¦
                    
                    // ç”Ÿæˆæ–°ç‰©ä½“
                    if (Math.random() < 0.05) {
                        nextItems.push({
                            id: Date.now() + Math.random(),
                            x: Math.random() * 80 + 10,
                            y: -10,
                            type: Math.random() > 0.3 ? 'monster' : 'tea' // 70% æ˜¯æ€ªå…½, 30% æ˜¯å¥¶èŒ¶
                        });
                    }

                    // ç¢°æ’æ£€æµ‹ä¸æ¸…ç†
                    return nextItems.filter(item => {
                        if (item.y > 100) return false;
                        
                        // ç®€å•ç¢°æ’æ£€æµ‹
                        const hit = item.y > 80 && item.y < 95 && Math.abs(item.x - playerX) < 10;
                        
                        if (hit) {
                            if (item.type === 'monster') {
                                setGameOver(true);
                                cancelAnimationFrame(requestRef.current);
                                return false;
                            } else {
                                setScore(s => s + 10);
                                return false; // åƒæ‰å¥¶èŒ¶
                            }
                        }
                        return true;
                    });
                });

                requestRef.current = requestAnimationFrame(loop);
            };

            useEffect(() => {
                requestRef.current = requestAnimationFrame(loop);
                return () => cancelAnimationFrame(requestRef.current);
            }, [playerX, gameOver]);

            useEffect(() => {
                if (gameOver) {
                    let stars = 1;
                    if (score > 50) stars = 2;
                    if (score > 100) stars = 3;
                    setTimeout(() => onFinish(score, stars), 1500);
                }
            }, [gameOver]);

            return (
                <div 
                    className="relative w-full h-full bg-slate-800 overflow-hidden cursor-crosshair" 
                    onTouchMove={handleTouch}
                    onMouseMove={handleMouse} // æ–°å¢é¼ æ ‡äº‹ä»¶
                >
                    <div className="absolute top-4 left-4 text-white text-xl font-bold">åˆ†æ•°: {score}</div>
                    
                    {/* ç©å®¶ */}
                    <div className="absolute bottom-4 w-12 h-12 transition-all duration-75" style={{ left: `calc(${playerX}% - 24px)` }}>
                         <Mimi className="w-full h-full" emotion={gameOver ? 'shock' : 'normal'} />
                    </div>

                    {/* æ‰è½ç‰© */}
                    {items.map(item => (
                        <div key={item.id} className="absolute w-10 h-10 flex items-center justify-center text-2xl" 
                             style={{ left: `calc(${item.x}% - 20px)`, top: `${item.y}%` }}>
                            {/* å›¾æ ‡æ›´æ–°ï¼šå‰ä»»(å¿ƒç¢)æ”¹ä¸ºæ€ªå…½(ğŸ‘¾) */}
                            {item.type === 'monster' ? 'ğŸ‘¾' : 'ğŸ§‹'}
                        </div>
                    ))}

                    {gameOver && <div className="absolute inset-0 flex items-center justify-center bg-black/50 text-white text-3xl font-bold">è¢«æ€ªå…½æŠ“ä½äº†ï¼</div>}
                    {!gameOver && <div className="absolute bottom-20 w-full text-center text-white/50 text-sm">ç§»åŠ¨é¼ æ ‡/æ»‘åŠ¨æ‰‹æŒ‡èº²é¿æ€ªå…½</div>}
                </div>
            );
        };

        // 3.2 æŠ¢ä¸‰æ–‡é±¼ (Sushi Duel)
        const GameSushiDuel = ({ onFinish }) => {
            const [state, setState] = useState('waiting'); // waiting, ready, click, result
            const [message, setMessage] = useState('ç­‰å¾…...');
            const [reactionTime, setReactionTime] = useState(0);
            const timerRef = useRef();
            const startTimeRef = useRef();

            useEffect(() => {
                startRound();
                return () => clearTimeout(timerRef.current);
            }, []);

            const startRound = () => {
                setState('waiting');
                setMessage('ç­‰å¾…ç»¿è‰²ä¿¡å·...');
                const delay = 2000 + Math.random() * 3000;
                timerRef.current = setTimeout(() => {
                    setState('ready');
                    setMessage('æŠ¢ï¼ï¼ï¼');
                    startTimeRef.current = Date.now();
                }, delay);
            };

            const handleClick = () => {
                if (state === 'waiting') {
                    setState('result');
                    setMessage('å¤ªæ—©äº†ï¼çŠ¯è§„ï¼');
                    setTimeout(() => onFinish(0, 1), 1500);
                } else if (state === 'ready') {
                    const time = Date.now() - startTimeRef.current;
                    setReactionTime(time);
                    setState('result');
                    setMessage(`è€—æ—¶: ${time}ms`);
                    
                    let stars = 1;
                    if (time < 500) stars = 2;
                    if (time < 300) stars = 3;
                    setTimeout(() => onFinish(time, stars), 1500);
                }
            };

            return (
                <div className={`w-full h-full flex flex-col items-center justify-center transition-colors duration-200 ${state === 'ready' ? 'bg-green-500' : 'bg-red-100'}`}
                     onMouseDown={handleClick} onTouchStart={handleClick}>
                    <div className="text-6xl mb-8">{state === 'ready' ? 'ğŸ£' : 'ğŸ½ï¸'}</div>
                    <h2 className="text-3xl font-bold text-slate-800">{message}</h2>
                    {state === 'waiting' && <p className="mt-4 text-slate-500">çœ‹åˆ°å˜ç»¿ç«‹åˆ»ç‚¹å‡»å±å¹•ï¼</p>}
                </div>
            );
        };

        // 3.3 å”¤é†’èŒ¸èŒ¸ (Wake Up - Tap Spam)
        const GameWakeUp = ({ onFinish }) => {
            const [progress, setProgress] = useState(0);
            const [timeLeft, setTimeLeft] = useState(10);
            const [gameEnded, setGameEnded] = useState(false);

            useEffect(() => {
                const timer = setInterval(() => {
                    if (timeLeft > 0 && !gameEnded) {
                        setTimeLeft(t => t - 1);
                        setProgress(p => Math.max(0, p - 3)); // è¡°å‡
                    } else if (timeLeft <= 0 && !gameEnded) {
                        endGame();
                    }
                }, 100); // è¿™é‡Œçš„è®¡æ—¶å™¨å…¶å®æ˜¯è¡°å‡å¾ªç¯ï¼ŒUIå€’è®¡æ—¶å¦ç®—
                
                const countDown = setInterval(() => {
                     if (timeLeft > 0 && !gameEnded) setTimeLeft(t => t - 0.1);
                }, 100);

                return () => { clearInterval(timer); clearInterval(countDown); }
            }, [timeLeft, gameEnded]);

            const handleTap = () => {
                if (gameEnded) return;
                const newProgress = progress + 8;
                setProgress(newProgress);
                if (newProgress >= 100) {
                    endGame(true);
                }
            };

            const endGame = (success = false) => {
                setGameEnded(true);
                if (success) {
                    setTimeout(() => onFinish(100, 3), 1000);
                } else {
                    let stars = 1;
                    if (progress > 50) stars = 2;
                    setTimeout(() => onFinish(progress, stars), 1000);
                }
            };

            return (
                <div className="w-full h-full bg-orange-100 flex flex-col items-center justify-center relative select-none"
                     onTouchStart={(e) => { e.preventDefault(); handleTap(); }} 
                     onMouseDown={handleTap}>
                    
                    <div className="absolute top-4 right-4 text-2xl font-bold text-orange-600">{Math.ceil(timeLeft)}s</div>
                    
                    <div className="relative w-40 h-40 mb-8">
                        <Rongrong className="w-full h-full" emotion={progress >= 100 ? 'shock' : 'normal'} />
                        {progress < 100 && (
                            <div className="absolute -top-4 right-0 text-2xl animate-bounce">ğŸ’¤</div>
                        )}
                    </div>

                    <div className="w-64 h-8 bg-white rounded-full border-2 border-orange-300 overflow-hidden mb-4">
                        <div className="h-full bg-orange-500 transition-all duration-75" style={{ width: `${Math.min(100, progress)}%` }}></div>
                    </div>
                    
                    <p className="text-xl font-bold text-orange-800 animate-pulse">ç–¯ç‹‚ç‚¹å‡»å”¤é†’ä»–ï¼</p>
                    {progress >= 100 && <h2 className="text-3xl text-red-600 font-bold absolute bottom-20">é†’äº†ï¼ï¼ï¼</h2>}
                </div>
            );
        };

        // 3.4 é»˜å¥‘è€ƒéªŒ (Mind Reader)
        const GameMindReader = ({ onFinish }) => {
            const questions = [
                { q: "èŒ¸èŒ¸ä¸Šå•æ‰€æœ€çˆ±å¸¦ä»€ä¹ˆï¼Ÿ", options: ["æ‰‹æœº", "ä¹¦", "ç©ºæ°”", "Switch"], correct: 0 },
                { q: "ç±³ç±³æœ€è®¨åŒçš„é£Ÿç‰©æ˜¯ï¼Ÿ", options: ["é¦™èœ", "èƒ¡èåœ", "å‰ä»»åšçš„é¥­", "è‹¦ç“œ"], correct: 2 },
                { q: "ä¸¤äººè°çš„èŠ‚æ“æ›´å°‘ï¼Ÿ", options: ["ç±³ç±³", "èŒ¸èŒ¸", "åŠæ–¤å…«ä¸¤", "è´Ÿæ•°"], correct: 2 }
            ];
            const [qIndex, setQIndex] = useState(0);
            const [correctCount, setCorrectCount] = useState(0);
            const [showResult, setShowResult] = useState(false);

            const handleAnswer = (index) => {
                if (index === questions[qIndex].correct) {
                    setCorrectCount(c => c + 1);
                }
                
                if (qIndex < questions.length - 1) {
                    setQIndex(q => q + 1);
                } else {
                    finishGame(correctCount + (index === questions[qIndex].correct ? 1 : 0));
                }
            };

            const finishGame = (finalCount) => {
                setShowResult(true);
                let stars = 1;
                if (finalCount >= 2) stars = 2;
                if (finalCount === 3) stars = 3;
                setTimeout(() => onFinish(finalCount * 100, stars), 1500);
            };

            if (showResult) return <div className="w-full h-full flex items-center justify-center text-2xl font-bold">ç­”å¯¹ {correctCount} é¢˜ï¼</div>;

            const q = questions[qIndex];

            return (
                <div className="w-full h-full bg-pink-50 p-6 flex flex-col items-center justify-center">
                    <div className="bg-white p-6 rounded-xl shadow-lg w-full max-w-md mb-8">
                        <h3 className="text-xl font-bold text-slate-800 mb-4 text-center">{q.q}</h3>
                    </div>
                    <div className="grid grid-cols-2 gap-4 w-full max-w-md">
                        {q.options.map((opt, i) => (
                            <button key={i} onClick={() => handleAnswer(i)}
                                    className="bg-indigo-100 hover:bg-indigo-200 text-indigo-800 py-4 rounded-lg font-bold transition-colors active:scale-95">
                                {opt}
                            </button>
                        ))}
                    </div>
                    <div className="mt-8 flex gap-4">
                        <Mimi className="w-16 h-16" />
                        <Rongrong className="w-16 h-16" />
                    </div>
                </div>
            );
        };

        // --- 4. ä¸»ç¨‹åºé€»è¾‘ ---

        const App = () => {
            // æ¸¸æˆçŠ¶æ€
            const [saveData, setSaveData] = useState({
                shards: 0,
                storyIndex: 0,
                highScores: {}
            });
            const [currentView, setCurrentView] = useState('menu'); // menu, story, game, result
            const [activeGameId, setActiveGameId] = useState(null);
            const [gameResult, setGameResult] = useState(null); // { score, stars, shardsEarned }
            const [activeStory, setActiveStory] = useState(null);

            // åŠ è½½å­˜æ¡£
            useEffect(() => {
                const saved = localStorage.getItem('rr_adventure_save');
                if (saved) {
                    setSaveData(JSON.parse(saved));
                } else {
                    // æ–°æ¸¸æˆï¼Œè§¦å‘Intro
                    setTimeout(() => triggerStory('intro'), 500);
                }
            }, []);

            // è‡ªåŠ¨å­˜æ¡£
            useEffect(() => {
                localStorage.setItem('rr_adventure_save', JSON.stringify(saveData));
            }, [saveData]);

            // æ£€æŸ¥å‰§æƒ…è§¦å‘
            useEffect(() => {
                if (currentView === 'menu') {
                    const nextStoryNode = STORY_NODES[saveData.storyIndex + 1];
                    // ä¿®æ­£é€»è¾‘ï¼šå¦‚æœå½“å‰å­˜æ¡£æ˜¯0ç¢ç‰‡çš„åˆå§‹çŠ¶æ€ï¼Œä¸”æ²¡çœ‹è¿‡introï¼Œè¿™éƒ¨åˆ†åœ¨ä¸Šé¢çš„åŠ è½½useEffectå¤„ç†äº†
                    // è¿™é‡Œå¤„ç†åç»­å‰§æƒ…
                    if (nextStoryNode && saveData.shards >= nextStoryNode.shardsRequired) {
                         setTimeout(() => triggerStory(nextStoryNode.id), 500);
                    }
                }
            }, [saveData.shards, currentView]);

            const triggerStory = (storyId) => {
                const story = STORY_NODES.find(n => n.id === storyId);
                if (story) {
                    setActiveStory(story);
                    setCurrentView('story');
                }
            };

            const finishStory = () => {
                // æ›´æ–°å‰§æƒ…è¿›åº¦
                const storyIdx = STORY_NODES.findIndex(n => n.id === activeStory.id);
                if (storyIdx >= saveData.storyIndex) {
                     setSaveData(prev => ({ ...prev, storyIndex: storyIdx }));
                }
                setCurrentView('menu');
                setActiveStory(null);
            };

            const startGame = (gameId) => {
                setActiveGameId(gameId);
                setCurrentView('game');
            };

            const finishGame = (score, stars) => {
                const shardsEarned = stars; // 1æ˜Ÿ=1ç‰‡ï¼Œ3æ˜Ÿ=3ç‰‡
                setGameResult({ score, stars, shardsEarned });
                
                setSaveData(prev => ({
                    ...prev,
                    shards: prev.shards + shardsEarned,
                    highScores: {
                        ...prev.highScores,
                        [activeGameId]: Math.max(score, prev.highScores[activeGameId] || 0)
                    }
                }));
                
                setCurrentView('result');
            };

            // --- è§†å›¾æ¸²æŸ“ ---

            // 1. å‰§æƒ…è§†å›¾
            const StoryView = () => {
                const [dialogIndex, setDialogIndex] = useState(0);
                const d = activeStory.dialogs[dialogIndex];

                const nextDialog = () => {
                    if (dialogIndex < activeStory.dialogs.length - 1) {
                        setDialogIndex(i => i + 1);
                    } else {
                        finishStory();
                    }
                };

                return (
                    <div className="fixed inset-0 bg-black/90 z-50 flex flex-col items-center justify-end pb-10" onClick={nextDialog}>
                        <div className="absolute top-10 text-white text-xl font-bold opacity-50">{activeStory.title}</div>
                        
                        {/* è§’è‰²å±•ç¤ºåŒº */}
                        <div className="flex justify-center items-end w-full mb-4 px-8 gap-4">
                            <Mimi className={`w-32 h-32 transition-all duration-300 ${d.char === 'mimi' ? 'scale-110 brightness-100' : 'scale-90 brightness-50 grayscale'}`} />
                            <Rongrong className={`w-32 h-32 transition-all duration-300 ${d.char === 'rong' ? 'scale-110 brightness-100' : 'scale-90 brightness-50 grayscale'}`} />
                        </div>

                        {/* å¯¹è¯æ¡† */}
                        <div className="w-11/12 bg-white rounded-xl p-6 border-4 border-slate-200 animate-slide-in">
                            <h4 className="font-bold text-lg mb-2 text-indigo-600">
                                {d.char === 'mimi' ? 'ç±³ç±³' : d.char === 'rong' ? 'èŒ¸èŒ¸' : 'æ—ç™½'}
                            </h4>
                            <p className="text-lg text-slate-800 leading-relaxed">{d.text}</p>
                            <div className="text-right text-xs text-slate-400 mt-4">ç‚¹å‡»ç»§ç»­ â–¶</div>
                        </div>
                    </div>
                );
            };

            // 2. ç»“ç®—è§†å›¾
            const ResultView = () => {
                return (
                    <div className="fixed inset-0 bg-white z-40 flex flex-col items-center justify-center p-8">
                        <h2 className="text-3xl font-bold mb-8">ç»“ç®—</h2>
                        <div className="flex gap-2 mb-6">
                            {[1, 2, 3].map(i => (
                                <Star key={i} size={48} 
                                      className={`${i <= gameResult.stars ? 'text-yellow-400 fill-yellow-400 animate-bounce-custom' : 'text-gray-300'}`} 
                                      style={{ animationDelay: `${i * 0.2}s` }}
                                />
                            ))}
                        </div>
                        <div className="text-xl mb-8 flex items-center gap-2">
                            è·å¾— <span className="text-2xl font-bold text-indigo-600">+{gameResult.shardsEarned}</span> èŠ‚æ“ç¢ç‰‡
                        </div>
                        <div className="flex gap-4 w-full">
                            <button onClick={() => startGame(activeGameId)} className="flex-1 bg-blue-500 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2">
                                <RotateCcw /> é‡ç©
                            </button>
                            <button onClick={() => setCurrentView('menu')} className="flex-1 bg-green-500 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2">
                                <Home /> è¿”å›
                            </button>
                        </div>
                    </div>
                );
            };

            // 3. èœå•è§†å›¾
            const MenuView = () => {
                // æ¸…é™¤å­˜æ¡£åŠŸèƒ½ (Debugç”¨)
                const resetSave = () => {
                    if(confirm("ç¡®å®šè¦åˆ é™¤å­˜æ¡£é‡ç½®æ¸¸æˆå—ï¼Ÿ")) {
                        localStorage.removeItem('rr_adventure_save');
                        window.location.reload();
                    }
                };

                return (
                    <div className="min-h-screen bg-[#FFF8E1] pb-20">
                        {/* é¡¶éƒ¨æ  */}
                        <div className="bg-white p-4 shadow-sm sticky top-0 z-10 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="bg-indigo-100 p-2 rounded-full"><Brain size={20} className="text-indigo-600"/></div>
                                <span className="font-bold text-lg">{saveData.shards} èŠ‚æ“</span>
                            </div>
                            <button onClick={resetSave} className="text-xs text-red-300">é‡ç½®</button>
                        </div>

                        {/* åœ°å›¾/å…³å¡åˆ—è¡¨ */}
                        <div className="p-4 grid gap-4">
                            <div className="text-center py-6">
                                <h1 className="text-2xl font-extrabold text-slate-800 mb-2">èŒ¸èŒ¸ç±³ç±³ã®å¤§å†’é™©</h1>
                                <p className="text-slate-500 text-sm">å½“å‰ç›®æ ‡ï¼šæ”¶é›†ç¢ç‰‡æ¨è¿›å‰§æƒ…</p>
                            </div>

                            {GAMES.map((game, index) => {
                                const isLocked = saveData.shards < game.cost && false; // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæš‚æ—¶ä¸çœŸçš„é”ä½ï¼Œåªåšè§†è§‰æç¤ºã€‚
                                // ç®€åŒ–ï¼šæ ¹æ®é˜ˆå€¼è§£é”
                                const realLocked = saveData.shards < game.threshold;

                                return (
                                    <div key={game.id} 
                                         className={`relative bg-white p-4 rounded-2xl shadow-md border-b-4 border-slate-200 flex items-center gap-4 transition-transform active:scale-95 ${realLocked ? 'opacity-70 grayscale' : ''}`}
                                         onClick={() => !realLocked && startGame(game.id)}>
                                        
                                        <div className={`w-16 h-16 rounded-xl flex items-center justify-center text-white ${realLocked ? 'bg-slate-400' : 'bg-orange-400'}`}>
                                            {game.icon}
                                        </div>
                                        
                                        <div className="flex-1">
                                            <h3 className="font-bold text-lg text-slate-800">{game.name}</h3>
                                            <p className="text-xs text-slate-500">{game.desc}</p>
                                        </div>

                                        {realLocked ? (
                                            <div className="flex flex-col items-center text-slate-400 px-2">
                                                <Lock size={20} />
                                                <span className="text-xs mt-1">{game.threshold}ç¢ç‰‡</span>
                                            </div>
                                        ) : (
                                            <div className="bg-green-100 text-green-700 p-2 rounded-full">
                                                <Play size={20} fill="currentColor" />
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        
                        {/* è£…é¥° */}
                        <div className="fixed bottom-0 w-full flex justify-between px-8 pointer-events-none">
                            <Mimi className="w-24 h-24 translate-y-4" />
                            <Rongrong className="w-24 h-24 translate-y-4" />
                        </div>
                    </div>
                );
            };

            // æ¸²æŸ“è·¯ç”±
            return (
                <>
                    {currentView === 'menu' && <MenuView />}
                    {currentView === 'story' && <StoryView />}
                    {currentView === 'result' && <ResultView />}
                    {currentView === 'game' && (
                        <div className="fixed inset-0 bg-white z-50">
                            <button onClick={() => setCurrentView('menu')} className="absolute top-4 right-4 z-50 bg-white/50 p-2 rounded-full">
                                <Home size={20} />
                            </button>
                            {activeGameId === 'avoid_ex' && <GameAvoidEx onFinish={finishGame} />}
                            {activeGameId === 'sushi_duel' && <GameSushiDuel onFinish={finishGame} />}
                            {activeGameId === 'wake_up' && <GameWakeUp onFinish={finishGame} />}
                            {activeGameId === 'mind_reader' && <GameMindReader onFinish={finishGame} />}
                        </div>
                    )}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>