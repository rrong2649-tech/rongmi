<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç±³ç±³å¥³ç‹çš„çˆ†ç¬‘åŠå…¬å®¤</title>
    <!-- 1. è®¾ç½®è®©ç½‘é¡µåƒAppä¸€æ ·å…¨å±è¿è¡Œ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fdf2f8">
    
    <!-- 2. ä½¿ç”¨å›½å†… Staticfile CDN åŠ é€Ÿ Tailwind CSS -->
    <link href="https://cdn.staticfile.org/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    
    <!-- 3. å¼•å…¥ React å’Œ Babel (å›½å†…æº) -->
    <script crossorigin src="https://cdn.staticfile.org/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.staticfile.org/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.staticfile.org/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        /* ç¦æ­¢é€‰æ‹©æ–‡æœ¬ï¼ŒåƒAppä¸€æ · */
        body { -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
        /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* åŠ¨ç”» */
        @keyframes bounce { 0%, 100% { transform: translateY(-5%); } 50% { transform: translateY(0); } }
        .animate-bounce { animation: bounce 1s infinite; }
    </style>
</head>
<body class="bg-pink-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- æ•°æ®é…ç½® (å›¾æ ‡æ¢æˆäº†Emojiä»¥ç¡®ä¿ç¦»çº¿å¯ç”¨) ---
        const CHARACTERS = {
            mimi: { name: "ç±³ç±³å¥³ç‹", color: "text-pink-600", bg: "bg-pink-100", avatar: "ğŸ‘‘" },
            shang: { name: "å°å°š", color: "text-yellow-600", bg: "bg-yellow-100", avatar: "ğŸ¶" },
            lixing: { name: "ææ˜Ÿ", color: "text-blue-600", bg: "bg-blue-100", avatar: "ğŸ‘“" },
            rong: { name: "èŒ¸èŒ¸", color: "text-purple-600", bg: "bg-purple-100", avatar: "ğŸ¯" },
            jun: { name: "ä¸½å°å›", color: "text-gray-600", bg: "bg-gray-200", avatar: "ğŸš¬" },
            du: { name: "å°æœ", color: "text-green-600", bg: "bg-green-100", avatar: "ğŸ¸" },
            boss: { name: "ç§ƒå¤´è€æ¿", color: "text-red-800", bg: "bg-red-100", avatar: "ğŸ‘¨â€ğŸ¦²" }
        };

        // --- å°æ¸¸æˆç»„ä»¶ ---
        const QTEGame = ({ onFinish, difficulty = 1, title = "å¿«é€Ÿååº”ï¼" }) => {
            const [progress, setProgress] = useState(20);
            const [timeLeft, setTimeLeft] = useState(5000 / difficulty);
            const [status, setStatus] = useState('playing');
            
            useEffect(() => {
                if (status !== 'playing') return;
                const timer = setInterval(() => {
                    setTimeLeft(prev => Math.max(0, prev - 100));
                    setProgress(prev => Math.max(0, prev - (0.5 * difficulty)));
                }, 100);
                return () => clearInterval(timer);
            }, [status, difficulty]);

            useEffect(() => {
                if (status === 'playing' && timeLeft <= 0) {
                    setStatus('fail');
                    onFinish('C');
                }
            }, [timeLeft, status]);

            const handleAction = () => {
                if (status !== 'playing') return;
                const newProgress = progress + 8;
                if (newProgress >= 100) {
                    setStatus('win');
                    onFinish(timeLeft > 2000 ? 'S' : 'A');
                } else {
                    setProgress(newProgress);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center h-64 bg-yellow-50 rounded-xl p-4 select-none active:scale-95 transition-transform" onTouchStart={handleAction} onClick={handleAction}>
                    <h3 className="text-xl font-bold mb-4 text-yellow-800">âš¡ {title}</h3>
                    <div className="text-sm text-gray-500 mb-2">ç‹‚ç‚¹å±å¹•ï¼</div>
                    <div className="w-full h-8 bg-gray-200 rounded-full overflow-hidden border-2 border-yellow-400 mb-4 relative">
                        <div className="absolute top-0 left-0 h-full bg-yellow-400 transition-all duration-75" style={{ width: `${progress}%` }}></div>
                    </div>
                    <div className="text-2xl font-black text-red-500">{(timeLeft / 1000).toFixed(1)}s</div>
                </div>
            );
        };

        const RhythmGame = ({ onFinish, icon = "ğŸµ" }) => {
            const [targets, setTargets] = useState([]);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(10000);
            const [isEnded, setIsEnded] = useState(false);

            useEffect(() => {
                if (isEnded) return;
                const timer = setInterval(() => setTimeLeft(prev => Math.max(0, prev - 100)), 100);
                return () => clearInterval(timer);
            }, [isEnded]);

            useEffect(() => {
                if (!isEnded && timeLeft <= 0) {
                    setIsEnded(true);
                    onFinish(score >= 10 ? 'S' : score >= 5 ? 'A' : 'B');
                }
            }, [timeLeft, isEnded]);

            useEffect(() => {
                if (isEnded) return;
                const spawner = setInterval(() => {
                    if (Math.random() > 0.3) {
                        const id = Date.now() + Math.random();
                        setTargets(prev => [...prev, { id, x: Math.random() * 80, y: Math.random() * 80 }]);
                        setTimeout(() => setTargets(prev => prev.filter(t => t.id !== id)), 1200);
                    }
                }, 500);
                return () => clearInterval(spawner);
            }, [isEnded]);

            const hit = (id, e) => {
                e.stopPropagation();
                if (isEnded) return;
                setScore(s => s + 1);
                setTargets(t => t.filter(i => i.id !== id));
            };

            return (
                <div className="relative h-64 bg-indigo-900 rounded-xl overflow-hidden select-none">
                    <div className="absolute top-2 left-2 text-white font-bold z-10">Combo: {score}</div>
                    <div className="absolute top-2 right-2 text-white font-bold z-10">{(timeLeft/1000).toFixed(1)}s</div>
                    {targets.map(t => (
                        <div key={t.id} className="absolute w-14 h-14 bg-pink-400 rounded-full flex items-center justify-center text-2xl border-4 border-white animate-bounce active:scale-90"
                             style={{ left: `${t.x}%`, top: `${t.y}%` }}
                             onTouchStart={(e) => hit(t.id, e)} onClick={(e) => hit(t.id, e)}>
                            {icon}
                        </div>
                    ))}
                </div>
            );
        };

        // --- äº‹ä»¶åº“ (ç²¾ç®€ç‰ˆç¤ºä¾‹) ---
        const EVENT_POOL = [
            { id: 1, char: "shang", title: "é‡‘æ¯›ä¸å‡å‘", desc: "å°å°šçš„é‡‘æ¯›å¼ç€HRçš„å‡å‘ç‹‚å¥”ï¼", choices: [
                { text: "âš¡ [QTE] å¸®å°å°šæŠ“ä½ç‹—ï¼", type: "game", gameType: "qte", rewards: { S: { kpi:5, san:10, pres:5, msg:"å®Œç¾æ•è·ï¼" }, C: { kpi:-5, san:-5, pres:-5, msg:"ç‹—è·‘äº†..." } } },
                { text: "å‡è£…æ²¡çœ‹è§", type: "instant", effects: { san:0, kpi:0, pres:-5 } }
            ]},
            { id: 2, char: "rong", title: "çŒ«çŒ«é»‘å®¢", desc: "èŒ¸èŒ¸æŠŠæ‰“å¡ç³»ç»Ÿå…¨æ¢æˆäº†çŒ«çŒ«å¤´ã€‚", choices: [
                { text: "ğŸµ [èŠ‚å¥] ä¸¾åŠçŒ«çŒ«æ‘„å½±èµ›", type: "game", gameType: "rhythm", gameProps: { icon: "ğŸ±" }, rewards: { S: { kpi:-5, san:15, pres:5, msg:"å…¨å‘˜å—¨ç¿»ï¼" }, B: { san:5, msg:"æœ‰ç‚¹æ„æ€ã€‚" } } },
                { text: "å‹’ä»¤æ”¹å›", type: "instant", effects: { san:-5, kpi:5, pres:5 } }
            ]},
            { id: 3, char: "lixing", title: "å¿«é€’å µé—¨", desc: "ææ˜Ÿçš„å¿«é€’å µä½äº†æ¶ˆé˜²é€šé“ã€‚", choices: [
                { text: "æš´åŠ›æ¨å€’", type: "instant", effects: { san:5, kpi:-5, pres:0 } },
                { text: "å¸®å¥¹ä¸€èµ·æ‹† (San+5)", type: "instant", effects: { san:5, kpi:0, pres:5 } }
            ]},
             { id: 4, char: "du", title: "ç”µæ¢¯ç›´è¨€", desc: "å°æœå¯¹è€æ¿è¯´ï¼šæ‚¨å„¿å­é•¿å¾—çœŸä¸åƒæ‚¨ã€‚", choices: [
                { text: "è£…æ­»", type: "instant", effects: { san:-5, kpi:0, pres:-5 } },
                { text: "å¸®è…”è¯´ç¡®å®ä¸åƒ (å¨æœ›-10)", type: "instant", effects: { san:10, kpi:-10, pres:-10 } }
            ]}
        ];

        // --- ä¸»ç¨‹åº ---
        const App = () => {
            const [gameState, setGameState] = useState('start');
            const [stats, setStats] = useState({ kpi: 50, san: 50, pres: 50 });
            const [month, setMonth] = useState(1);
            const [currentEvent, setCurrentEvent] = useState(null);
            const [miniGameConfig, setMiniGameConfig] = useState(null);
            const [resultMsg, setResultMsg] = useState("");

            const startGame = () => {
                setStats({ kpi: 50, san: 50, pres: 50 });
                setMonth(1);
                setGameState('playing');
                setCurrentEvent(EVENT_POOL[0]);
            };

            const handleChoice = (choice) => {
                if (choice.type === 'game') {
                    setMiniGameConfig({ ...choice, rewards: choice.rewards, props: choice.gameProps });
                    setGameState('minigame');
                } else {
                    applyEffects(choice.effects, "æ³¢æ¾œä¸æƒŠçš„ä¸€å¤©ã€‚");
                }
            };

            const finishMiniGame = (grade) => {
                const reward = miniGameConfig.rewards[grade] || miniGameConfig.rewards['B'] || { kpi:0, san:0, pres:0, msg:"ç»“æœä¸€èˆ¬" };
                applyEffects(reward, `è¯„çº§ ${grade}: ${reward.msg}`);
            };

            const applyEffects = (eff, msg) => {
                const nextStats = {
                    kpi: Math.max(0, Math.min(100, stats.kpi + (eff.kpi || 0))),
                    san: Math.max(0, Math.min(100, stats.san + (eff.san || 0))),
                    pres: Math.max(0, Math.min(100, stats.pres + (eff.pres || 0)))
                };
                setStats(nextStats);
                setResultMsg(msg);
                
                if (nextStats.kpi <= 0 || nextStats.san <= 0 || nextStats.pres <= 0) {
                    setGameState('gameover');
                } else if (month >= 20) {
                    setGameState('victory');
                } else {
                    setGameState('result');
                }
            };

            const nextMonth = () => {
                setMonth(m => m + 1);
                setGameState('playing');
                setCurrentEvent(EVENT_POOL[Math.floor(Math.random() * EVENT_POOL.length)]);
            };

            // è¿›åº¦æ¡ç»„ä»¶
            const Bar = ({ label, val, color, icon }) => (
                <div className="flex-1">
                    <div className="text-xs font-bold mb-1 flex items-center justify-center gap-1"><span>{icon}</span> {label}</div>
                    <div className="h-3 bg-gray-200 rounded-full overflow-hidden border border-gray-300">
                        <div className={`h-full ${color} transition-all duration-500`} style={{width: `${val}%`}}></div>
                    </div>
                </div>
            );

            if (gameState === 'start') return (
                <div className="h-screen flex flex-col items-center justify-center p-6 bg-pink-50">
                    <div className="text-6xl mb-6 animate-bounce">ğŸ‘‘</div>
                    <h1 className="text-3xl font-black text-pink-600 mb-2 text-center">ç±³ç±³å¥³ç‹çš„<br/>çˆ†ç¬‘åŠå…¬å®¤</h1>
                    <p className="text-gray-500 mb-8">iOS å•æœºç‰¹ä¾›ç‰ˆ</p>
                    <button onClick={startGame} className="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 text-xl">å¼€å§‹ä¸Šç­</button>
                </div>
            );

            if (gameState === 'gameover' || gameState === 'victory') return (
                <div className="h-screen flex flex-col items-center justify-center p-6 bg-gray-100">
                    <div className="text-6xl mb-4">{gameState === 'victory' ? 'ğŸ†' : 'ğŸ˜­'}</div>
                    <h2 className="text-2xl font-bold mb-4">{gameState === 'victory' ? 'é¡ºåˆ©é€šå…³' : 'è¢«ç‚’é±¿é±¼'}</h2>
                    <button onClick={startGame} className="w-full bg-purple-600 text-white font-bold py-3 rounded-xl shadow mt-8">é‡æ–°å¼€å§‹</button>
                </div>
            );

            const char = CHARACTERS[currentEvent?.char] || CHARACTERS.boss;

            return (
                <div className="h-screen flex flex-col bg-gray-50 overflow-hidden">
                    {/* é¡¶éƒ¨æ  */}
                    <div className="bg-white p-3 shadow-sm z-10 pt-safe-top">
                        <div className="flex justify-between items-center mb-2">
                            <span className="font-black text-xl">ç¬¬ {month} æœˆ</span>
                            <span className="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded-full">Appç‰ˆ</span>
                        </div>
                        <div className="flex gap-2">
                            <Bar label="KPI" val={stats.kpi} color="bg-blue-400" icon="ğŸ’¼" />
                            <Bar label="San" val={stats.san} color="bg-pink-400" icon="â¤ï¸" />
                            <Bar label="å¨æœ›" val={stats.pres} color="bg-yellow-400" icon="ğŸ‘‘" />
                        </div>
                    </div>

                    {/* æ¸¸æˆåŒº */}
                    <div className="flex-1 overflow-y-auto p-4 pb-20">
                        {gameState === 'minigame' ? (
                            <div className="bg-white p-4 rounded-2xl shadow-xl border-4 border-indigo-200">
                                {miniGameConfig.gameType === 'qte' && <QTEGame onFinish={finishMiniGame} difficulty={1.2} />}
                                {miniGameConfig.gameType === 'rhythm' && <RhythmGame onFinish={finishMiniGame} {...miniGameConfig.props} />}
                            </div>
                        ) : gameState === 'result' ? (
                            <div className="bg-white p-6 rounded-2xl shadow-xl text-center mt-10">
                                <h3 className="font-bold text-lg mb-2">æœˆåº¦æ€»ç»“</h3>
                                <p className="text-gray-600 mb-6">{resultMsg}</p>
                                <button onClick={nextMonth} className="w-full bg-gray-800 text-white font-bold py-3 rounded-xl">ä¸‹ä¸ªæœˆ</button>
                            </div>
                        ) : (
                            <div className="animate-fade-in-up">
                                <div className={`relative ${char.bg} p-6 rounded-3xl border-2 border-white shadow-lg mt-8 text-center`}>
                                    <div className="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-white p-2 rounded-full shadow text-4xl border-4 border-white">{char.avatar}</div>
                                    <div className={`text-sm font-bold uppercase mt-6 mb-1 ${char.color}`}>{char.name}</div>
                                    <h2 className="text-xl font-black text-gray-800 mb-3">{currentEvent.title}</h2>
                                    <p className="text-gray-700 bg-white/60 p-3 rounded-xl text-left">{currentEvent.desc}</p>
                                </div>
                                <div className="mt-6 space-y-3">
                                    {currentEvent.choices.map((c, i) => (
                                        <button key={i} onClick={() => handleChoice(c)} className="w-full bg-white p-4 rounded-xl text-left shadow-sm border-2 border-gray-100 active:bg-gray-50">
                                            <span className="font-bold mr-2 text-gray-400">{["A","B"][i]}.</span>
                                            <span className="font-bold text-gray-800">{c.text}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
